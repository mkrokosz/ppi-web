name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - preview

env:
  AWS_REGION: us-east-1
  STACK_NAME: proplastics-website

permissions:
  id-token: write
  contents: read

jobs:
  deploy-infrastructure:
    name: Deploy CloudFormation Stack
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Validate CloudFormation template
        run: |
          aws cloudformation validate-template \
            --template-body file://infrastructure/cloudformation.yaml

      - name: Look up Hosted Zone ID
        id: hosted-zone
        run: |
          HOSTED_ZONE_ID=$(aws route53 list-hosted-zones-by-name \
            --dns-name proplastics.us \
            --query "HostedZones[?Name=='proplastics.us.'].Id" \
            --output text | sed 's|/hostedzone/||')

          if [ -z "$HOSTED_ZONE_ID" ]; then
            echo "Error: Could not find hosted zone for proplastics.us"
            exit 1
          fi

          echo "Found Hosted Zone ID: $HOSTED_ZONE_ID"
          echo "hosted_zone_id=$HOSTED_ZONE_ID" >> $GITHUB_OUTPUT

      - name: Preview changes (Change Set)
        if: ${{ github.event.inputs.action == 'preview' }}
        run: |
          aws cloudformation deploy \
            --template-file infrastructure/cloudformation.yaml \
            --stack-name ${{ env.STACK_NAME }} \
            --parameter-overrides \
              DomainName=proplastics.us \
              HostedZoneId=${{ steps.hosted-zone.outputs.hosted_zone_id }} \
            --capabilities CAPABILITY_IAM \
            --no-execute-changeset

          echo "## Change Set Preview" >> $GITHUB_STEP_SUMMARY
          echo "Review the change set in the AWS Console before deploying." >> $GITHUB_STEP_SUMMARY

      - name: Deploy CloudFormation stack
        if: ${{ github.event.inputs.action == 'deploy' }}
        run: |
          aws cloudformation deploy \
            --template-file infrastructure/cloudformation.yaml \
            --stack-name ${{ env.STACK_NAME }} \
            --parameter-overrides \
              DomainName=proplastics.us \
              HostedZoneId=${{ steps.hosted-zone.outputs.hosted_zone_id }} \
            --capabilities CAPABILITY_IAM \
            --no-fail-on-empty-changeset

      - name: Get stack outputs
        if: ${{ github.event.inputs.action == 'deploy' }}
        run: |
          echo "## Infrastructure Deployed! :white_check_mark:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          BUCKET_NAME=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --query "Stacks[0].Outputs[?OutputKey=='WebsiteBucketName'].OutputValue" \
            --output text)

          DISTRIBUTION_ID=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --query "Stacks[0].Outputs[?OutputKey=='CloudFrontDistributionId'].OutputValue" \
            --output text)

          WEBSITE_URL=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --query "Stacks[0].Outputs[?OutputKey=='WebsiteURL'].OutputValue" \
            --output text)

          echo "**S3 Bucket:** \`$BUCKET_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**CloudFront Distribution ID:** \`$DISTRIBUTION_ID\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Website URL:** $WEBSITE_URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "Add these as GitHub Secrets:" >> $GITHUB_STEP_SUMMARY
          echo "- \`S3_BUCKET_NAME\`: $BUCKET_NAME" >> $GITHUB_STEP_SUMMARY
          echo "- \`CLOUDFRONT_DISTRIBUTION_ID\`: $DISTRIBUTION_ID" >> $GITHUB_STEP_SUMMARY
