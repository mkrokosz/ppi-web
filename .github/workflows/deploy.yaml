name: Deploy to AWS

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production

env:
  AWS_REGION: us-east-1
  NODE_VERSION: '20'
  STACK_NAME: proplastics-website

permissions:
  id-token: write
  contents: read

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: out/
          retention-days: 1

  deploy:
    name: Deploy to AWS
    needs: build
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout (for infrastructure template)
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: out/

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check if infrastructure exists
        id: check-infra
        run: |
          if aws cloudformation describe-stacks --stack-name ${{ env.STACK_NAME }} > /dev/null 2>&1; then
            echo "stack_exists=true" >> $GITHUB_OUTPUT
          else
            echo "stack_exists=false" >> $GITHUB_OUTPUT
            echo "⚠️ Infrastructure stack does not exist. Deploying infrastructure first..."
          fi

      - name: Look up Hosted Zone ID
        if: steps.check-infra.outputs.stack_exists == 'false'
        id: hosted-zone
        run: |
          HOSTED_ZONE_ID=$(aws route53 list-hosted-zones-by-name \
            --dns-name proplastics.us \
            --query "HostedZones[?Name=='proplastics.us.'].Id" \
            --output text | sed 's|/hostedzone/||')

          if [ -z "$HOSTED_ZONE_ID" ]; then
            echo "Error: Could not find hosted zone for proplastics.us"
            exit 1
          fi

          echo "Found Hosted Zone ID: $HOSTED_ZONE_ID"
          echo "hosted_zone_id=$HOSTED_ZONE_ID" >> $GITHUB_OUTPUT

      - name: Deploy infrastructure
        if: steps.check-infra.outputs.stack_exists == 'false'
        run: |
          echo "Deploying CloudFormation stack..."
          aws cloudformation deploy \
            --template-file infrastructure/cloudformation.yaml \
            --stack-name ${{ env.STACK_NAME }} \
            --parameter-overrides \
              DomainName=proplastics.us \
              HostedZoneId=${{ steps.hosted-zone.outputs.hosted_zone_id }} \
            --capabilities CAPABILITY_IAM \
            --no-fail-on-empty-changeset

          echo "✅ Infrastructure deployed"

      - name: Get CloudFormation outputs
        id: cfn-outputs
        run: |
          echo "Fetching outputs from CloudFormation stack: ${{ env.STACK_NAME }}"

          # Wait for stack to be ready if just created
          aws cloudformation wait stack-exists --stack-name ${{ env.STACK_NAME }}

          S3_BUCKET=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --query "Stacks[0].Outputs[?OutputKey=='WebsiteBucketName'].OutputValue" \
            --output text)

          DISTRIBUTION_ID=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --query "Stacks[0].Outputs[?OutputKey=='CloudFrontDistributionId'].OutputValue" \
            --output text)

          if [ -z "$S3_BUCKET" ] || [ "$S3_BUCKET" == "None" ]; then
            echo "Error: Could not find S3 bucket name from stack outputs"
            exit 1
          fi

          if [ -z "$DISTRIBUTION_ID" ] || [ "$DISTRIBUTION_ID" == "None" ]; then
            echo "Error: Could not find CloudFront distribution ID from stack outputs"
            exit 1
          fi

          echo "S3 Bucket: $S3_BUCKET"
          echo "CloudFront Distribution: $DISTRIBUTION_ID"

          echo "s3_bucket=$S3_BUCKET" >> $GITHUB_OUTPUT
          echo "distribution_id=$DISTRIBUTION_ID" >> $GITHUB_OUTPUT

      - name: Sync to S3
        run: |
          aws s3 sync out/ s3://${{ steps.cfn-outputs.outputs.s3_bucket }}/ \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "*.html"

          # HTML files with shorter cache
          aws s3 sync out/ s3://${{ steps.cfn-outputs.outputs.s3_bucket }}/ \
            --delete \
            --cache-control "public, max-age=0, must-revalidate" \
            --exclude "*" \
            --include "*.html"

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ steps.cfn-outputs.outputs.distribution_id }} \
            --paths "/*"

      - name: Deployment summary
        run: |
          echo "## Deployment Complete! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Website URL:** https://proplastics.us" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**S3 Bucket:** ${{ steps.cfn-outputs.outputs.s3_bucket }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**CloudFront Distribution:** ${{ steps.cfn-outputs.outputs.distribution_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Cache invalidation has been triggered. Changes may take a few minutes to propagate." >> $GITHUB_STEP_SUMMARY
