name: Deploy to AWS

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production

env:
  AWS_REGION: us-east-1
  NODE_VERSION: '20'
  STACK_NAME: proplastics-website

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Python (for SAM CLI)
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Setup SAM CLI
        uses: aws-actions/setup-sam@v2

      - name: Look up Hosted Zone ID
        id: hosted-zone
        run: |
          HOSTED_ZONE_ID=$(aws route53 list-hosted-zones-by-name \
            --dns-name proplastics.us \
            --query "HostedZones[?Name=='proplastics.us.'].Id" \
            --output text | sed 's|/hostedzone/||')

          if [ -z "$HOSTED_ZONE_ID" ]; then
            echo "Error: Could not find hosted zone for proplastics.us"
            exit 1
          fi

          echo "Found Hosted Zone ID: $HOSTED_ZONE_ID"
          echo "hosted_zone_id=$HOSTED_ZONE_ID" >> $GITHUB_OUTPUT

      - name: Deploy infrastructure with SAM
        working-directory: infrastructure
        run: |
          echo "Deploying infrastructure with SAM..."
          sam deploy \
            --template-file cloudformation.yaml \
            --stack-name ${{ env.STACK_NAME }} \
            --parameter-overrides \
              DomainName=proplastics.us \
              HostedZoneId=${{ steps.hosted-zone.outputs.hosted_zone_id }} \
              ContactEmailRecipient=mattkrokosz@gmail.com \
              SESFromEmail=noreply@proplastics.us \
              RecaptchaSecretKey=${{ secrets.RECAPTCHA_SECRET_KEY }} \
              RecaptchaScoreThreshold=0.5 \
            --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM CAPABILITY_AUTO_EXPAND \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --resolve-s3

          echo "âœ… Infrastructure deployed"

      - name: Get CloudFormation outputs
        id: cfn-outputs
        run: |
          echo "Fetching outputs from CloudFormation stack: ${{ env.STACK_NAME }}"

          # Wait for stack to be ready
          aws cloudformation wait stack-exists --stack-name ${{ env.STACK_NAME }}

          S3_BUCKET=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --query "Stacks[0].Outputs[?OutputKey=='WebsiteBucketName'].OutputValue" \
            --output text)

          DISTRIBUTION_ID=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --query "Stacks[0].Outputs[?OutputKey=='CloudFrontDistributionId'].OutputValue" \
            --output text)

          CONTACT_API_URL=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --query "Stacks[0].Outputs[?OutputKey=='ContactFormApiUrl'].OutputValue" \
            --output text)

          if [ -z "$S3_BUCKET" ] || [ "$S3_BUCKET" == "None" ]; then
            echo "Error: Could not find S3 bucket name from stack outputs"
            exit 1
          fi

          if [ -z "$DISTRIBUTION_ID" ] || [ "$DISTRIBUTION_ID" == "None" ]; then
            echo "Error: Could not find CloudFront distribution ID from stack outputs"
            exit 1
          fi

          echo "S3 Bucket: $S3_BUCKET"
          echo "CloudFront Distribution: $DISTRIBUTION_ID"
          echo "Contact API URL: $CONTACT_API_URL"

          echo "s3_bucket=$S3_BUCKET" >> $GITHUB_OUTPUT
          echo "distribution_id=$DISTRIBUTION_ID" >> $GITHUB_OUTPUT
          echo "contact_api_url=$CONTACT_API_URL" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        env:
          NEXT_PUBLIC_CONTACT_API_URL: ${{ steps.cfn-outputs.outputs.contact_api_url }}
          NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          NEXT_PUBLIC_RECAPTCHA_SITE_KEY: ${{ secrets.RECAPTCHA_SITE_KEY }}
        run: npm run build

      - name: Sync to S3
        run: |
          aws s3 sync out/ s3://${{ steps.cfn-outputs.outputs.s3_bucket }}/ \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "*.html"

          # HTML files with shorter cache
          aws s3 sync out/ s3://${{ steps.cfn-outputs.outputs.s3_bucket }}/ \
            --delete \
            --cache-control "public, max-age=0, must-revalidate" \
            --exclude "*" \
            --include "*.html"

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ steps.cfn-outputs.outputs.distribution_id }} \
            --paths "/*"

      - name: Deployment summary
        run: |
          echo "## Deployment Complete! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Website URL:** https://proplastics.us" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**S3 Bucket:** ${{ steps.cfn-outputs.outputs.s3_bucket }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**CloudFront Distribution:** ${{ steps.cfn-outputs.outputs.distribution_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Contact Form API:** ${{ steps.cfn-outputs.outputs.contact_api_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Cache invalidation has been triggered. Changes may take a few minutes to propagate." >> $GITHUB_STEP_SUMMARY
