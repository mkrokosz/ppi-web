name: Deploy to AWS

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production

env:
  AWS_REGION: us-east-1
  NODE_VERSION: '20'
  STACK_NAME: proplastics-website

permissions:
  id-token: write
  contents: read

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install test dependencies
        working-directory: infrastructure/lambda
        run: |
          python -m pip install --upgrade pip
          pip install -r tests/requirements.txt

      - name: Run Lambda unit tests
        working-directory: infrastructure/lambda
        run: |
          pytest tests/ -v --tb=short

  deploy:
    name: Build and Deploy
    needs: test
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Look up Hosted Zone ID
        id: hosted-zone
        run: |
          HOSTED_ZONE_ID=$(aws route53 list-hosted-zones-by-name \
            --dns-name proplastics.us \
            --query "HostedZones[?Name=='proplastics.us.'].Id" \
            --output text | sed 's|/hostedzone/||')

          if [ -z "$HOSTED_ZONE_ID" ]; then
            echo "Error: Could not find hosted zone for proplastics.us"
            exit 1
          fi

          echo "Found Hosted Zone ID: $HOSTED_ZONE_ID"
          echo "hosted_zone_id=$HOSTED_ZONE_ID" >> $GITHUB_OUTPUT

      - name: Check which paths changed
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            dwg-converter:
              - 'infrastructure/lambda/dwg-converter/**'
            preview-generator:
              - 'infrastructure/lambda/preview-generator/**'

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Create ECR repository and build DWG converter image
        if: steps.changes.outputs.dwg-converter == 'true' || github.event_name == 'workflow_dispatch'
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ env.STACK_NAME }}-dwg-converter
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Create ECR repository if it doesn't exist (needed before CloudFormation)
          echo "Ensuring ECR repository exists..."
          aws ecr describe-repositories --repository-names $ECR_REPOSITORY 2>/dev/null || \
            aws ecr create-repository --repository-name $ECR_REPOSITORY --image-scanning-configuration scanOnPush=true

          echo "Building DWG converter Docker image..."
          cd infrastructure/lambda/dwg-converter

          docker build --platform linux/amd64 -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest

          echo "Pushing to ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

          echo "✅ DWG converter image pushed to ECR"

      - name: Skip DWG converter build (no changes)
        if: steps.changes.outputs.dwg-converter != 'true' && github.event_name != 'workflow_dispatch'
        run: echo "⏭️ Skipping DWG converter build - no changes detected"

      - name: Create ECR repository and build Preview generator image
        if: steps.changes.outputs.preview-generator == 'true' || github.event_name == 'workflow_dispatch'
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ env.STACK_NAME }}-preview-generator
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Create ECR repository if it doesn't exist (needed before CloudFormation)
          echo "Ensuring ECR repository exists..."
          aws ecr describe-repositories --repository-names $ECR_REPOSITORY 2>/dev/null || \
            aws ecr create-repository --repository-name $ECR_REPOSITORY --image-scanning-configuration scanOnPush=true

          echo "Building Preview generator Docker image..."
          cd infrastructure/lambda/preview-generator

          docker build --platform linux/amd64 -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest

          echo "Pushing to ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

          echo "✅ Preview generator image pushed to ECR"

      - name: Skip Preview generator build (no changes)
        if: steps.changes.outputs.preview-generator != 'true' && github.event_name != 'workflow_dispatch'
        run: echo "⏭️ Skipping Preview generator build - no changes detected"

      - name: Package and Deploy infrastructure
        working-directory: infrastructure
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ env.STACK_NAME }}-dwg-converter
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "Packaging Lambda code..."
          # Use the website bucket for Lambda artifacts
          ARTIFACT_BUCKET="proplastics.us-website"

          # Package the template (uploads Lambda code to S3)
          aws cloudformation package \
            --template-file cloudformation.yaml \
            --s3-bucket $ARTIFACT_BUCKET \
            --s3-prefix lambda-artifacts \
            --output-template-file packaged.yaml

          echo "Deploying CloudFormation stack..."
          aws cloudformation deploy \
            --template-file packaged.yaml \
            --stack-name ${{ env.STACK_NAME }} \
            --parameter-overrides \
              DomainName=proplastics.us \
              HostedZoneId=${{ steps.hosted-zone.outputs.hosted_zone_id }} \
              ContactEmailRecipient=dennisk@proplasticsinc.com,mattk@proplasticsinc.com \
              ContactEmailCc= \
              ContactEmailBcc= \
              SESFromEmail=noreply@proplastics.us \
              RecaptchaSecretKey=${{ secrets.RECAPTCHA_SECRET_KEY }} \
              RecaptchaScoreThreshold=0.5 \
            --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM CAPABILITY_AUTO_EXPAND \
            --no-fail-on-empty-changeset

          echo "✅ Infrastructure deployed"

      - name: Update DWG converter Lambda
        if: steps.changes.outputs.dwg-converter == 'true' || github.event_name == 'workflow_dispatch'
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ env.STACK_NAME }}-dwg-converter
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "Updating DWG converter Lambda with new image..."
          aws lambda update-function-code \
            --function-name ${{ env.STACK_NAME }}-dwg-converter \
            --image-uri $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            --no-cli-pager || echo "Lambda update skipped (function may not exist yet)"
          echo "✅ DWG converter Lambda updated"

      - name: Update Preview generator Lambda
        if: steps.changes.outputs.preview-generator == 'true' || github.event_name == 'workflow_dispatch'
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ env.STACK_NAME }}-preview-generator
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "Updating Preview generator Lambda with new image..."
          aws lambda update-function-code \
            --function-name ${{ env.STACK_NAME }}-preview-generator \
            --image-uri $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            --no-cli-pager || echo "Lambda update skipped (function may not exist yet)"
          echo "✅ Preview generator Lambda updated"

      - name: Get CloudFormation outputs
        id: cfn-outputs
        run: |
          echo "Fetching outputs from CloudFormation stack: ${{ env.STACK_NAME }}"

          # Wait for stack to be ready
          aws cloudformation wait stack-exists --stack-name ${{ env.STACK_NAME }}

          S3_BUCKET=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --query "Stacks[0].Outputs[?OutputKey=='WebsiteBucketName'].OutputValue" \
            --output text)

          DISTRIBUTION_ID=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --query "Stacks[0].Outputs[?OutputKey=='CloudFrontDistributionId'].OutputValue" \
            --output text)

          # Use custom domain URL (api.proplastics.us) instead of raw API Gateway URL
          API_CUSTOM_DOMAIN=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --query "Stacks[0].Outputs[?OutputKey=='ApiCustomDomainUrl'].OutputValue" \
            --output text)

          # Contact form endpoint
          CONTACT_API_URL="${API_CUSTOM_DOMAIN}/contact"

          if [ -z "$S3_BUCKET" ] || [ "$S3_BUCKET" == "None" ]; then
            echo "Error: Could not find S3 bucket name from stack outputs"
            exit 1
          fi

          if [ -z "$DISTRIBUTION_ID" ] || [ "$DISTRIBUTION_ID" == "None" ]; then
            echo "Error: Could not find CloudFront distribution ID from stack outputs"
            exit 1
          fi

          echo "S3 Bucket: $S3_BUCKET"
          echo "CloudFront Distribution: $DISTRIBUTION_ID"
          echo "API Custom Domain: $API_CUSTOM_DOMAIN"
          echo "Contact API URL: $CONTACT_API_URL"

          echo "s3_bucket=$S3_BUCKET" >> $GITHUB_OUTPUT
          echo "distribution_id=$DISTRIBUTION_ID" >> $GITHUB_OUTPUT
          echo "api_custom_domain=$API_CUSTOM_DOMAIN" >> $GITHUB_OUTPUT
          echo "contact_api_url=$CONTACT_API_URL" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        env:
          NEXT_PUBLIC_CONTACT_API_URL: ${{ steps.cfn-outputs.outputs.contact_api_url }}
          NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          NEXT_PUBLIC_RECAPTCHA_SITE_KEY: ${{ secrets.RECAPTCHA_SITE_KEY }}
        run: npm run build

      - name: Sync to S3
        run: |
          aws s3 sync out/ s3://${{ steps.cfn-outputs.outputs.s3_bucket }}/ \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "*.html"

          # HTML files with shorter cache
          aws s3 sync out/ s3://${{ steps.cfn-outputs.outputs.s3_bucket }}/ \
            --delete \
            --cache-control "public, max-age=0, must-revalidate" \
            --exclude "*" \
            --include "*.html"

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ steps.cfn-outputs.outputs.distribution_id }} \
            --paths "/*"

      - name: Deployment summary
        run: |
          echo "## Deployment Complete! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Website URL:** https://proplastics.us" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**S3 Bucket:** ${{ steps.cfn-outputs.outputs.s3_bucket }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**CloudFront Distribution:** ${{ steps.cfn-outputs.outputs.distribution_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**API Custom Domain:** ${{ steps.cfn-outputs.outputs.api_custom_domain }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Contact Form API:** ${{ steps.cfn-outputs.outputs.contact_api_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Google Lead Webhook:** ${{ steps.cfn-outputs.outputs.api_custom_domain }}/google-lead" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**DWG Converter:** ${{ env.STACK_NAME }}-dwg-converter (Lambda container)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Preview Generator:** ${{ env.STACK_NAME }}-preview-generator (Lambda container)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Cache invalidation has been triggered. Changes may take a few minutes to propagate." >> $GITHUB_STEP_SUMMARY
